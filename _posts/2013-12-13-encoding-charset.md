---
layout: post
title: 前端工程师的编码问题
published: true
tags: [encoding charset unicode ucs UTF-8 UTF-16 编码 字符集]
---

## 基本概念

这篇文章分两个部分。第一部分梳理一下字符集和编码的基础知识，比如unicode、ucs、utf-8、utf-16等的关系，
第二部分整理一下前端工程师可能会遇到的一些编码问题。我的初衷是想能穷尽所有问题，但是我又知道这是不可能的，
所以只能尽量多的把搜集到的以及遇到过的问题整理出来。

### 字符集与编码

通常我们讲到的字符是一种文化符号，比如'中华'二字。顾名思义，字符集就是一套字符的集合。

众所周知，计算机只能处理/存储二进制数据，也就是一系列的0、1串。那么怎么用计算机来显示和处理人类文明使用的字符呢？
这就需要对字符进行编码，简单来说就是建立二进制数字和字符之间的对应关系。比如在
ASCII这套字符集中65就代表大写字母'A'。

那么，在计算机的范畴内, 字符集编码通常包含了两部分的内容：1、一套字符集
2、这套字符集与二进制数字的对应关系，这套对应关系叫做码表。比如繁体字'華'就不会在GB2312的码表中，
因为设计GB2312时就没有把繁体'華'字收录进去。

前面说到了字符集和码表的概念。现在说说字符怎么存储与读取。
为方便说明，后文主要以文本文件存储到硬盘和从硬盘中读取文件并显示为例。出于节省存储空间等方面的考虑，
通常字符并不是按照码表中对应的二进制直接存储的，而是将这个二进制数字再经过一次运算得到另一个更短的二进制串，
最终存储的是这个更短的二进制串，这个运算叫做编码。这有点类似twitter和微博等使用的短域名。

文本文件的大致存储过程是这样的：

1. 查找码表，得到字符对应的二进制串A
2. 将A按一定规则进行转换得到二进制串B
3. 将二进制B存储到硬盘

注意：步骤2可能没有。

读取文本文件就是相反的过程：

1. 从硬盘中读取数据，得到二进制串B
2. 将B按一定规则进行转换得到二进制串A
3. 查找码表，找到二进制串A对应的字符，并显示字符

注意：步骤2可能没有。

这个世界上存在着很多不同的字符集和各自相应的编码方式，比如ASCII，比如GB2312,GBK,
GB18030，同一套字符集可能会有不同的编码方式，比如UTF-8,UTF-16都使用unicode这套字符集。

当然你也可以设计自己的字符集，比如你设计一套字符集叫做前端字符集，
这套字符集只包括“前端工程师”这五个简体中文字，分别使用'0000000','0000001','0000010',
'0000011','0000100'，当读取数据时每次取一个字节，然后在码表中找到对应的字符，
如果读取的字节不是这5个字节的任意一个，那么你就显示为一个乱码。

好了，介绍了字符、字符集、码表、编码的基本概念，下面来看看中文程序员用到最多的几种编码。
(据我观察在程序员的日常交流中，很多时候字符集、字符集编码、编码泛指一个概念)

### ASCII

最初，计算机只在美国使用，由于英文符号比较少，美国人就使用1个字节来对他们使用到的字符进行编码，
这就是ASCII码(American Standard Code for Information Interchange，美国信息交换标准代码)。

1个字节可以表示256种不同的状态(2^8=256)，也就是说ASCII最多包含256个字符。实际上ASCII才使用到了第127号。
其中从0开始的32种状态被用做一些特殊用途。比如终端遇到0x07就会发出叫声。这些0x20以下的状态被成为'控制码'。

### ISO-8859-1

> ISO 8859-1，正式编号为ISO/IEC 8859-1:1998，又称Latin-1或“西欧语言”，
> 是国际标准化组织内ISO/IEC 8859的第一个8位字符集。它以ASCII为基础，在空置的0xA0-0xFF的范围内，
> 加入96个字母及符号，藉以供使用附加符号的拉丁字母语言使用。

它是ASCII的一种扩展字符集。其实后面要讲到的GB2312,GBK,GB18030都是对ASCII的扩展。

### GB2312

等到中国人使用计算机时发现ASCII里没有中文字符，而且一个字节最多编码256个字符，
远远不能满足中文的需要，中文的常用汉字就有6000多个。于是聪明的国人干脆就用两个字节来表示汉字。
规定：   

1. 一个小于127的字节与ASCII中对应的字符相同
2. 两个连续大于127的字节一起表示一个中文字符
3. 前面的一个字节（高字节）从0xA1用到0xF7，后面一个字节（低字节）从0xA1到0xFE，这样就可以组合出大约7000多个汉字了。

这套字符集和编码方案就是GB2312。

当读取数据时，先取一个字节A，如果A小于127，A就与其在ASCII中表示相同的含义(控制码或者字符);
如果A大于127，那么再取下一个字节B，如果B也大于127，那么AB一起表示一个汉字，在码表中查询其对应的字符。
如果码表中没有AB对应的字节，或者B小于127，那么就显示乱码或者进行出错处理。

### GBK和GB18030

后来人们发现GB2312的编码方式还是不够用，于是不再对低字节有要求，只要高字节大于127就表示连续两个字节表示一个汉字，
这样就能增加一些容量，可以加入新的字符了，于是就增加了近20000个新的汉字（包括繁体字）和符号，这就是GBK。

后来又加了几千个少数民族的字，这就是GB18030。

GB2312,GBK,GB18030这一系列字符集编码使用两个字节表示一个汉字，通称做"DBCS"(Double Byte Charecter Set 双字节字符集)。
这就是刚学程序设计时老师总要我们记住的'一个中文字符等于两个英文字符'。

### unicode和ISO-10646

世界上存在如此多的字符集编码，给交流造成了极大的困难。于是有人意识到有必要给全人类设计一套统一的字符集了。

不幸的是有两个独立的组织分别开始了这项工作，一个是国际标准化组织(ISO)，项目是ISO-10646;
另一个是由Apple，Xerox等公司于1988年组成的统一码盟(unicode.org)，项目就是unicode。

幸运的是，不久他们就发现了彼此的存在，两个项目的参与者都认识到，世界不需要两个不兼容的字符集。
于是它们开始合并双方的工作成果，并为创立一个单一编码表而协同工作。
1991年，不包含CJK统一汉字集的Unicode 1.0发布。随后，CJK统一汉字集的制定于1993年完成，
发布了ISO 10646-1:1993，即Unicode 1.1。

> 两个项目仍都独立存在，并独立地公布各自的标准。但统一码联盟和ISO都同意保持两者标准的码表兼容，
> 并紧密地共同调整任何未来的扩展。

也就是说，世界上存在两个统一字符集标准，但这两个标准是高度同步的，码表是一致的。
日常交流和技术书籍中使用unicode这个名字多一些。

unicode和ISO-10646定义的字符集就叫做通用字符集(Universal Character Set，UCS)。

unicode 1.x版本使用2个字节(16个位)编码，，这就是*UCS-2*。
从1996年发布unicode 2.0开始使用4个字节编码，这就是*UCS-4*。

UCS-2最多能表示2^16=65536个字符。UCS-4中只使用了31位，最高位为0。UCS-4在已使用的31位中，
按照最高字节可以分为2^7=128个group，每个group根据次高字节分为256个panel，
每个panel根据第三高字节分为256个row，每行有256个cells。
第0号group和第0号panel被称作**BMP**(Basic Multilingual Plane)。很明显BMP去掉高位的两个零字节就得到UCS-2。

### UTF-8、UTF-16、UTF-32和BOM

UTF-8的全称是"8-bit  Unicode Transformation Format"。
